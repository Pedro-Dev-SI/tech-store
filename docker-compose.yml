# =============================================================================
# Docker Compose para Produção / Testes E2E
# =============================================================================
# Sobe TUDO containerizado: infraestrutura + todos os microserviços
# Usado para: testes de integração, simular produção local, CI/CD
#
# Como usar:
#   docker-compose up --build        (builda e sobe tudo)
#   docker-compose up -d             (sobe em background)
#   docker-compose down              (para tudo)
#   docker-compose down -v           (para e apaga volumes)
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # INFRAESTRUTURA
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # PostgreSQL - Banco de dados principal
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: techstore-postgres
    environment:
      POSTGRES_USER: techstore
      POSTGRES_PASSWORD: techstore123
      POSTGRES_MULTIPLE_DATABASES: product_db,user_db,auth_db,inventory_db,order_db,payment_db,notification_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U techstore"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - techstore-network

  # ---------------------------------------------------------------------------
  # Zookeeper - Necessário para o Kafka
  # ---------------------------------------------------------------------------
  # zookeeper:
  #   image: confluentinc/cp-zookeeper:7.5.0
  #   container_name: techstore-zookeeper
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #     ZOOKEEPER_TICK_TIME: 2000
  #   ports:
  #     - "2181:2181"
  #   healthcheck:
  #     test: ["CMD", "nc", "-z", "localhost", "2181"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Apache Kafka - Mensageria / Event Bus
  # ---------------------------------------------------------------------------
  # kafka:
  #   image: confluentinc/cp-kafka:7.5.0
  #   container_name: techstore-kafka
  #   depends_on:
  #     zookeeper:
  #       condition: service_healthy
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     KAFKA_BROKER_ID: 1
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
  #     KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
  #     KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
  #     KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
  #     KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
  #   healthcheck:
  #     test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #   networks:
  #     - techstore-network

  # ===========================================================================
  # MICROSERVIÇOS
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # API Gateway - Ponto de entrada único
  # ---------------------------------------------------------------------------
  # api-gateway:
  #   build:
  #     context: ./api-gateway
  #     dockerfile: Dockerfile
  #   container_name: techstore-api-gateway
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - AUTH_SERVICE_URL=http://auth-service:8081
  #     - USER_SERVICE_URL=http://user-service:8082
  #     - PRODUCT_SERVICE_URL=http://product-service:8083
  #     - INVENTORY_SERVICE_URL=http://inventory-service:8084
  #     - ORDER_SERVICE_URL=http://order-service:8085
  #     - PAYMENT_SERVICE_URL=http://payment-service:8086
  #   depends_on:
  #     - auth-service
  #     - user-service
  #     - product-service
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Auth Service - Autenticação e JWT
  # ---------------------------------------------------------------------------
  # auth-service:
  #   build:
  #     context: ./auth-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-auth-service
  #   ports:
  #     - "8081:8081"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/auth_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - USER_SERVICE_URL=http://user-service:8082
  #     - JWT_SECRET=sua-chave-secreta-muito-segura-para-producao-minimo-256-bits
  #     - JWT_EXPIRATION=900000
  #     - JWT_REFRESH_EXPIRATION=604800000
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # User Service - Gerenciamento de usuários
  # ---------------------------------------------------------------------------
  # user-service:
  #   build:
  #     context: ./user-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-user-service
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/user_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     # kafka:
  #     #   condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Product Service - Catálogo de produtos
  # ---------------------------------------------------------------------------
  # product-service:
  #   build:
  #     context: ./product-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-product-service
  #   ports:
  #     - "8083:8083"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/product_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Inventory Service - Controle de estoque
  # ---------------------------------------------------------------------------
  # inventory-service:
  #   build:
  #     context: ./inventory-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-inventory-service
  #   ports:
  #     - "8084:8084"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/inventory_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
  #     - PRODUCT_SERVICE_URL=http://product-service:8083
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     product-service:
  #       condition: service_healthy
  #     # kafka:
  #     #   condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Order Service - Gerenciamento de pedidos
  # ---------------------------------------------------------------------------
  # order-service:
  #   build:
  #     context: ./order-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-order-service
  #   ports:
  #     - "8085:8085"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/order_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
  #     - PRODUCT_SERVICE_URL=http://product-service:8083
  #     - INVENTORY_SERVICE_URL=http://inventory-service:8084
  #     - USER_SERVICE_URL=http://user-service:8082
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     product-service:
  #       condition: service_healthy
  #     inventory-service:
  #       condition: service_healthy
  #     user-service:
  #       condition: service_healthy
  #     # kafka:
  #     #   condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Payment Service - Processamento de pagamentos
  # ---------------------------------------------------------------------------
  # payment-service:
  #   build:
  #     context: ./payment-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-payment-service
  #   ports:
  #     - "8086:8086"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/payment_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
  #     - ORDER_SERVICE_URL=http://order-service:8085
  #     - INVENTORY_SERVICE_URL=http://inventory-service:8084
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     order-service:
  #       condition: service_healthy
  #     # kafka:
  #     #   condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

  # ---------------------------------------------------------------------------
  # Notification Service - Envio de notificações
  # ---------------------------------------------------------------------------
  # notification-service:
  #   build:
  #     context: ./notification-service
  #     dockerfile: Dockerfile
  #   container_name: techstore-notification-service
  #   ports:
  #     - "8087:8087"
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/notification_db
  #     - SPRING_DATASOURCE_USERNAME=techstore
  #     - SPRING_DATASOURCE_PASSWORD=techstore123
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
  #     - MAIL_HOST=smtp.gmail.com
  #     - MAIL_PORT=587
  #     - MAIL_USERNAME=${MAIL_USERNAME}
  #     - MAIL_PASSWORD=${MAIL_PASSWORD}
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     # kafka:
  #     #   condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - techstore-network

# =============================================================================
# VOLUMES - Persistência de dados
# =============================================================================
volumes:
  postgres_data:
    driver: local

# =============================================================================
# NETWORKS - Rede interna dos containers
# =============================================================================
networks:
  techstore-network:
    driver: bridge

# =============================================================================
# PORTAS DOS SERVIÇOS (referência rápida)
# =============================================================================
# PostgreSQL:          5432
# Kafka:               9092
# Zookeeper:           2181
# API Gateway:         8080
# Auth Service:        8081
# User Service:        8082
# Product Service:     8083
# Inventory Service:   8084
# Order Service:       8085
# Payment Service:     8086
# Notification Service: 8087
# =============================================================================

